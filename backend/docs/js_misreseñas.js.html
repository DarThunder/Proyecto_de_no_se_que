<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: js/misreseñas.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: js/misreseñas.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file js/misreseñas.js
 * @description Gestiona la visualización y administración de las reseñas del usuario.
 * Permite listar el historial de opiniones, eliminar reseñas existentes y editar
 * el contenido (calificación, comentario, talla) mediante un modal dinámico.
 */

/**
 * Inicializa la carga de reseñas cuando el DOM está listo.
 * @listens document#DOMContentLoaded
 */
document.addEventListener("DOMContentLoaded", () => {
  loadUserReviews();
});

/**
 * Carga las reseñas del usuario actual desde el backend.
 * También gestiona la visualización de la información del usuario en el encabezado
 * y maneja los estados de "Cargando", "No autenticado" y "Sin reseñas".
 * @async
 */
async function loadUserReviews() {
  const container = document.getElementById("reviews-list");
  const loadingMsg = document.getElementById("loading-message");
  const loginRequiredMsg = document.getElementById("login-required-message");
  const emptyMsg = document.getElementById("empty-reviews-message");
  const userHeaderInfo = document.getElementById("user-header-info");
  const headerUsername = document.getElementById("header-username");

  try {
    // 1. Obtener datos del usuario (Verificación de sesión)
    const userResponse = await fetch("http://localhost:8080/users/me", {
      method: "GET",
      credentials: "include",
    });

    if (userResponse.status === 401) {
      loadingMsg.style.display = "none";
      loginRequiredMsg.style.display = "block";
      return;
    }

    if (!userResponse.ok) {
      throw new Error("Error al obtener datos del usuario");
    }

    const userData = await userResponse.json();

    // Mostrar nombre en el header si hay sesión
    userHeaderInfo.style.display = "flex";
    headerUsername.textContent = userData.username || "Cliente";

    // 2. Obtener las reseñas del usuario
    const reviewsResponse = await fetch(
      "http://localhost:8080/reviews/my-reviews",
      {
        method: "GET",
        credentials: "include",
      }
    );

    if (!reviewsResponse.ok) {
      throw new Error("Error del servidor al cargar reseñas");
    }

    const reviews = await reviewsResponse.json();
    loadingMsg.style.display = "none";

    if (reviews.length === 0) {
      emptyMsg.style.display = "block";
      return;
    }

    // 3. Renderizar lista de reseñas
    container.style.display = "block";
    reviews.forEach((review, index) => {
      const reviewHTML = createReviewHTML(review, index);
      container.innerHTML += reviewHTML;
    });
  } catch (error) {
    console.error("Error al cargar reseñas:", error);
    loadingMsg.style.display = "none";
    // Mostrar mensaje de error genérico en la UI
    loginRequiredMsg.innerHTML = `
            &lt;div class="login-icon">&lt;i class="fas fa-exclamation-triangle">&lt;/i>&lt;/div>
            &lt;h2>Error al cargar&lt;/h2>
            &lt;p>No se pudo conectar con el servidor. Intenta de nuevo más tarde.&lt;/p>`;
    loginRequiredMsg.style.display = "block";
  }
}

/**
 * Genera el HTML para una tarjeta de reseña individual.
 * @param {Object} review - Objeto con los datos de la reseña.
 * @param {number} index - Índice para calcular el retardo de la animación.
 * @returns {string} String HTML de la tarjeta.
 */
function createReviewHTML(review, index) {
  // Formateo de fecha
  const reviewDate = new Date(review.createdAt).toLocaleDateString("es-ES", {
    day: "numeric",
    month: "long",
    year: "numeric",
  });

  const starsHTML = createStarsHTML(review.rating);

  // Ajuste de ruta de imagen (subir un nivel desde /html/)
  const imageUrl = review.product.image_url
    ? `../${review.product.image_url}`
    : "../sources/img/logo_negro.png";
  const userName = review.user?.username || "Cliente";

  return `
        &lt;div class="review-card" style="animation-delay: ${index * 0.1}s">
            &lt;div class="review-card-header">
                &lt;div class="review-product-info">
                    &lt;div class="review-product-img" style="background-image: url('${imageUrl}')">&lt;/div>
                    &lt;div class="review-product-details">
                        &lt;h4>${review.product.name}&lt;/h4>
                        &lt;div class="review-product-meta">
                            &lt;span>&lt;strong>Por:&lt;/strong> ${userName}&lt;/span>
                            &lt;span>Categoría: ${review.product.category}&lt;/span>
                            &lt;span> • Talla: ${review.size}&lt;/span>
                        &lt;/div>
                    &lt;/div>
                &lt;/div>
                &lt;div class="review-rating">
                    ${starsHTML}
                &lt;/div>
            &lt;/div>
            &lt;div class="review-content">
                &lt;p class="review-comment">${review.comment}&lt;/p>
            &lt;/div>
            &lt;div class="review-meta">
                &lt;span>Reseñado el ${reviewDate}&lt;/span>
                &lt;div class="review-actions">
                    &lt;button class="btn-edit" onclick="editReview('${
                      review._id
                    }')">
                        &lt;i class="fas fa-edit">&lt;/i> Editar
                    &lt;/button>
                    &lt;button class="btn-delete" onclick="deleteReview('${
                      review._id
                    }')">
                        &lt;i class="fas fa-trash">&lt;/i> Eliminar
                    &lt;/button>
                &lt;/div>
            &lt;/div>
        &lt;/div>
    `;
}

/**
 * Genera el HTML de las estrellas de calificación (llenas/vacías).
 * @param {number} rating - Calificación numérica (1-5).
 * @returns {string} HTML de los iconos de estrellas.
 */
function createStarsHTML(rating) {
  let stars = "";
  for (let i = 1; i &lt;= 5; i++) {
    if (i &lt;= rating) {
      stars += '&lt;i class="fas fa-star star">&lt;/i>';
    } else {
      stars += '&lt;i class="far fa-star star empty">&lt;/i>';
    }
  }
  return stars;
}

/**
 * Elimina una reseña tras confirmar la acción con el usuario.
 * @async
 * @param {string} reviewId - ID de la reseña a eliminar.
 */
async function deleteReview(reviewId) {
  if (!confirm("¿Estás seguro de que quieres eliminar esta reseña?")) {
    return;
  }

  try {
    const response = await fetch(`http://localhost:8080/reviews/${reviewId}`, {
      method: "DELETE",
      credentials: "include",
    });

    if (response.ok) {
      alert("Reseña eliminada exitosamente");
      location.reload();
    } else {
      const error = await response.json();
      alert("Error al eliminar reseña: " + error.error);
    }
  } catch (error) {
    console.error("Error al eliminar reseña:", error);
    alert("Error al eliminar reseña");
  }
}

/** @type {string|null} ID de la reseña que se está editando actualmente. */
let editingReviewId = null;

/**
 * Inicia el proceso de edición de una reseña.
 * Extrae los datos actuales del DOM y abre el modal de edición.
 * @param {string} reviewId - ID de la reseña.
 */
function editReview(reviewId) {
  editingReviewId = reviewId;

  // Buscar la tarjeta de la reseña en el DOM para obtener sus datos actuales
  // Nota: Esto evita tener que hacer otra petición a la API
  const reviewCard = document
    .querySelector(`[onclick="editReview('${reviewId}')"]`)
    .closest(".review-card");

  // Extraer datos
  const currentRating = parseInt(
    reviewCard.querySelectorAll(".review-rating .fas.fa-star").length
  );
  const currentComment =
    reviewCard.querySelector(".review-comment").textContent;
  const currentSize = reviewCard
    .querySelector(".review-product-meta span:last-child")
    .textContent.replace("Talla: ", "")
    .replace("•", "")
    .trim();

  // Crear y mostrar modal
  createEditModal(currentRating, currentComment, currentSize);
}

/**
 * Crea dinámicamente el modal de edición e inyecta su HTML en el body.
 * @param {number} currentRating - Calificación actual.
 * @param {string} currentComment - Comentario actual.
 * @param {string} currentSize - Talla seleccionada actualmente.
 */
function createEditModal(currentRating, currentComment, currentSize) {
  // Crear overlay (fondo oscuro)
  const modalOverlay = document.createElement("div");
  modalOverlay.className = "modal-overlay";

  // Estilos inline para el overlay
  modalOverlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); display: flex; justify-content: center;
        align-items: center; z-index: 1000;
    `;

  // Contenido del modal
  modalOverlay.innerHTML = `
        &lt;div class="edit-modal" style="background: #1a1a1a; padding: 2rem; border-radius: 10px; width: 90%; max-width: 500px; border: 2px solid #333;">
            &lt;h3 style="color: white; margin-bottom: 1.5rem; text-align: center;">
                &lt;i class="fas fa-edit">&lt;/i> Editar Reseña
            &lt;/h3>
            
            &lt;div class="form-group">
                &lt;label style="color: white; display: block; margin-bottom: 0.5rem;">Calificación:&lt;/label>
                &lt;div class="rating-selector" id="edit-rating-selector" style="margin-bottom: 1rem;">
                    ${Array.from(
                      { length: 5 },
                      (_, i) => `
                        &lt;i class="fas fa-star rating-star ${
                          i &lt; currentRating ? "active" : ""
                        }" 
                           data-rating="${i + 1}"
                           style="color: ${
                             i &lt; currentRating ? "#ffd700" : "#666"
                           }; cursor: pointer; font-size: 1.5rem; margin: 0 0.2rem;">
                        &lt;/i>
                    `
                    ).join("")}
                &lt;/div>
                &lt;input type="hidden" id="edit-rating-value" value="${currentRating}">
            &lt;/div>

            &lt;div class="form-group">
                &lt;label style="color: white; display: block; margin-bottom: 0.5rem;">Talla:&lt;/label>
                &lt;div class="size-selector" id="edit-size-selector" style="margin-bottom: 1rem;">
                    ${["XS", "S", "M", "L", "XL"]
                      .map(
                        (size) => `
                        &lt;span class="size-option ${
                          size === currentSize ? "selected" : ""
                        }" 
                              data-size="${size}"
                              style="display: inline-block; padding: 0.5rem 1rem; margin: 0.2rem; border: 1px solid #333; border-radius: 5px; cursor: pointer; color: ${
                                size === currentSize ? "white" : "#666"
                              }; background: ${
                          size === currentSize ? "#333" : "transparent"
                        };">
                            ${size}
                        &lt;/span>
                    `
                      )
                      .join("")}
                &lt;/div>
                &lt;input type="hidden" id="edit-size-value" value="${currentSize}">
            &lt;/div>

            &lt;div class="form-group">
                &lt;label style="color: white; display: block; margin-bottom: 0.5rem;">Tu reseña:&lt;/label>
                &lt;textarea id="edit-comment" 
                          style="width: 100%; height: 120px; padding: 0.8rem; background: #2a2a2a; border: 1px solid #333; border-radius: 5px; color: white; resize: vertical;"
                          maxlength="500">${currentComment}&lt;/textarea>
                &lt;small style="color: #ccc; display: block; text-align: right;">
                    &lt;span id="edit-char-count">${
                      currentComment.length
                    }&lt;/span>/500 caracteres
                &lt;/small>
            &lt;/div>

            &lt;div style="text-align: center; margin-top: 1.5rem;">
                &lt;button type="button" onclick="closeEditModal()" 
                        style="margin-right: 1rem; padding: 0.8rem 1.5rem; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    &lt;i class="fas fa-times">&lt;/i> Cancelar
                &lt;/button>
                &lt;button type="button" onclick="submitEditReview()" 
                        style="padding: 0.8rem 1.5rem; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    &lt;i class="fas fa-save">&lt;/i> Guardar Cambios
                &lt;/button>
            &lt;/div>
        &lt;/div>
    `;

  document.body.appendChild(modalOverlay);

  // Configurar la interactividad del modal
  setupEditModalListeners();
}

/**
 * Configura los listeners internos del modal de edición.
 * Maneja la selección de estrellas, tallas y el contador de caracteres.
 */
function setupEditModalListeners() {
  // Interactividad de Estrellas
  document
    .querySelectorAll("#edit-rating-selector .rating-star")
    .forEach((star) => {
      star.addEventListener("click", () => {
        const rating = parseInt(star.dataset.rating);
        document.getElementById("edit-rating-value").value = rating;

        // Actualizar color de estrellas visualmente
        document
          .querySelectorAll("#edit-rating-selector .rating-star")
          .forEach((s, i) => {
            s.style.color = i &lt; rating ? "#ffd700" : "#666";
          });
      });
    });

  // Interactividad de Tallas
  document
    .querySelectorAll("#edit-size-selector .size-option")
    .forEach((option) => {
      option.addEventListener("click", () => {
        const size = option.dataset.size;
        document.getElementById("edit-size-value").value = size;

        // Actualizar estilo de selección
        document
          .querySelectorAll("#edit-size-selector .size-option")
          .forEach((opt) => {
            const isSelected = opt.dataset.size === size;
            opt.style.color = isSelected ? "white" : "#666";
            opt.style.background = isSelected ? "#333" : "transparent";
          });
      });
    });

  // Contador de caracteres en tiempo real
  document.getElementById("edit-comment").addEventListener("input", (e) => {
    document.getElementById("edit-char-count").textContent =
      e.target.value.length;
  });
}

/**
 * Cierra el modal de edición y limpia el estado global.
 */
function closeEditModal() {
  const modal = document.querySelector(".modal-overlay");
  if (modal) {
    modal.remove();
  }
  editingReviewId = null;
}

// Exponer función globalmente para los botones inline
window.closeEditModal = closeEditModal;

/**
 * Envía los datos actualizados de la reseña al backend.
 * Realiza validaciones básicas antes del envío.
 * @async
 */
window.submitEditReview = async function () {
  const rating = parseInt(document.getElementById("edit-rating-value").value);
  const size = document.getElementById("edit-size-value").value;
  const comment = document.getElementById("edit-comment").value.trim();

  // Validaciones
  if (!rating || !size || !comment) {
    alert("Por favor completa todos los campos");
    return;
  }

  if (comment.length &lt; 10) {
    alert("El comentario debe tener al menos 10 caracteres");
    return;
  }

  try {
    const response = await fetch(
      `http://localhost:8080/reviews/${editingReviewId}`,
      {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
        body: JSON.stringify({
          rating: rating,
          comment: comment,
          size: size,
        }),
      }
    );

    const result = await response.json();

    if (response.ok) {
      alert("¡Reseña actualizada exitosamente!");
      closeEditModal();
      location.reload(); // Recargar para mostrar cambios
    } else {
      alert("Error al actualizar reseña: " + result.error);
    }
  } catch (error) {
    console.error("Error al editar reseña:", error);
    alert("Error al editar reseña. Intenta de nuevo.");
  }
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CategoryManager.html">CategoryManager</a></li><li><a href="ProductManager.html">ProductManager</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:submit">submit</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addBtn">addBtn</a></li><li><a href="global.html#addWishlistListeners">addWishlistListeners</a></li><li><a href="global.html#allCategoryProducts">allCategoryProducts</a></li><li><a href="global.html#allowedOrigins">allowedOrigins</a></li><li><a href="global.html#applyFilters">applyFilters</a></li><li><a href="global.html#approveOrder">approveOrder</a></li><li><a href="global.html#availableRoles">availableRoles</a></li><li><a href="global.html#cancelBtn">cancelBtn</a></li><li><a href="global.html#cargarTerminosUsuario">cargarTerminosUsuario</a></li><li><a href="global.html#checkIfEmpty">checkIfEmpty</a></li><li><a href="global.html#checkLoginStatus">checkLoginStatus</a></li><li><a href="global.html#closeCouponModal">closeCouponModal</a></li><li><a href="global.html#closeEditModal">closeEditModal</a></li><li><a href="global.html#closeProviderModal">closeProviderModal</a></li><li><a href="global.html#closeUserModal">closeUserModal</a></li><li><a href="global.html#couponForm">couponForm</a></li><li><a href="global.html#createEditModal">createEditModal</a></li><li><a href="global.html#createOrderCardHTML">createOrderCardHTML</a></li><li><a href="global.html#createProductHTML">createProductHTML</a></li><li><a href="global.html#createReviewHTML">createReviewHTML</a></li><li><a href="global.html#createStarsHTML">createStarsHTML</a></li><li><a href="global.html#currentEditingUserId">currentEditingUserId</a></li><li><a href="global.html#currentUserRing">currentUserRing</a></li><li><a href="global.html#db">db</a></li><li><a href="global.html#deleteCoupon">deleteCoupon</a></li><li><a href="global.html#deleteProvider">deleteProvider</a></li><li><a href="global.html#deleteReview">deleteReview</a></li><li><a href="global.html#displayProducts">displayProducts</a></li><li><a href="global.html#editReview">editReview</a></li><li><a href="global.html#editarRol">editarRol</a></li><li><a href="global.html#editingCouponId">editingCouponId</a></li><li><a href="global.html#editingProviderId">editingProviderId</a></li><li><a href="global.html#editingReviewId">editingReviewId</a></li><li><a href="global.html#eliminarRol">eliminarRol</a></li><li><a href="global.html#form">form</a></li><li><a href="global.html#formatDate">formatDate</a></li><li><a href="global.html#generateCouponCode">generateCouponCode</a></li><li><a href="global.html#getStatusLabel">getStatusLabel</a></li><li><a href="global.html#getUrgencyLabel">getUrgencyLabel</a></li><li><a href="global.html#goBackToProducts">goBackToProducts</a></li><li><a href="global.html#handleFormSubmit">handleFormSubmit</a></li><li><a href="global.html#hasPermission">hasPermission</a></li><li><a href="global.html#initializeBarcodesModal">initializeBarcodesModal</a></li><li><a href="global.html#initializeCarousels">initializeCarousels</a></li><li><a href="global.html#initializeCatProductButtons">initializeCatProductButtons</a></li><li><a href="global.html#initializeCatWishlistButtons">initializeCatWishlistButtons</a></li><li><a href="global.html#initializeMessagesSystem">initializeMessagesSystem</a></li><li><a href="global.html#initializeProductButtons">initializeProductButtons</a></li><li><a href="global.html#initializeWishlistButtons">initializeWishlistButtons</a></li><li><a href="global.html#isEditing">isEditing</a></li><li><a href="global.html#loadBestSellersReport">loadBestSellersReport</a></li><li><a href="global.html#loadCartItems">loadCartItems</a></li><li><a href="global.html#loadCategoryProducts">loadCategoryProducts</a></li><li><a href="global.html#loadCoupons">loadCoupons</a></li><li><a href="global.html#loadDashboardStats">loadDashboardStats</a></li><li><a href="global.html#loadDynamicCategories">loadDynamicCategories</a></li><li><a href="global.html#loadEmployeeSalesReport">loadEmployeeSalesReport</a></li><li><a href="global.html#loadMessagesFromBackend">loadMessagesFromBackend</a></li><li><a href="global.html#loadProducts">loadProducts</a></li><li><a href="global.html#loadProviders">loadProviders</a></li><li><a href="global.html#loadRoles">loadRoles</a></li><li><a href="global.html#loadUserData">loadUserData</a></li><li><a href="global.html#loadUserDataAndProducts">loadUserDataAndProducts</a></li><li><a href="global.html#loadUserOrders">loadUserOrders</a></li><li><a href="global.html#loadUserReviews">loadUserReviews</a></li><li><a href="global.html#loadUsers">loadUsers</a></li><li><a href="global.html#loadWebOrders">loadWebOrders</a></li><li><a href="global.html#loadWishlistItems">loadWishlistItems</a></li><li><a href="global.html#markAllAsRead">markAllAsRead</a></li><li><a href="global.html#markMessageAsRead">markMessageAsRead</a></li><li><a href="global.html#modal">modal</a></li><li><a href="global.html#modalTitle">modalTitle</a></li><li><a href="global.html#moveItemToCart">moveItemToCart</a></li><li><a href="global.html#openCreateModal">openCreateModal</a></li><li><a href="global.html#openEditModal">openEditModal</a></li><li><a href="global.html#productGrid">productGrid</a></li><li><a href="global.html#productsToInsert">productsToInsert</a></li><li><a href="global.html#providerForm">providerForm</a></li><li><a href="global.html#recalculateSummary">recalculateSummary</a></li><li><a href="global.html#recalculateTotal">recalculateTotal</a></li><li><a href="global.html#rejectOrder">rejectOrder</a></li><li><a href="global.html#removeFromWishlist">removeFromWishlist</a></li><li><a href="global.html#removeItemFromCart">removeItemFromCart</a></li><li><a href="global.html#renderProducts">renderProducts</a></li><li><a href="global.html#resetForm">resetForm</a></li><li><a href="global.html#selectProduct">selectProduct</a></li><li><a href="global.html#selectedProduct">selectedProduct</a></li><li><a href="global.html#selectedProvider">selectedProvider</a></li><li><a href="global.html#selectedRating">selectedRating</a></li><li><a href="global.html#selectedSize">selectedSize</a></li><li><a href="global.html#sendPasswordResetEmail">sendPasswordResetEmail</a></li><li><a href="global.html#setupCartEventListeners">setupCartEventListeners</a></li><li><a href="global.html#setupEditModalListeners">setupEditModalListeners</a></li><li><a href="global.html#setupEventListeners">setupEventListeners</a></li><li><a href="global.html#setupFilterListeners">setupFilterListeners</a></li><li><a href="global.html#setupModal">setupModal</a></li><li><a href="global.html#setupScrollEffects">setupScrollEffects</a></li><li><a href="global.html#shippingData">shippingData</a></li><li><a href="global.html#showMessageDetail">showMessageDetail</a></li><li><a href="global.html#showMessagesError">showMessagesError</a></li><li><a href="global.html#showNotification">showNotification</a></li><li><a href="global.html#startMessagesRealTimeUpdates">startMessagesRealTimeUpdates</a></li><li><a href="global.html#submitReview">submitReview</a></li><li><a href="global.html#tableBody">tableBody</a></li><li><a href="global.html#toggleWishlistItem">toggleWishlistItem</a></li><li><a href="global.html#toggleWishlistItemCat">toggleWishlistItemCat</a></li><li><a href="global.html#transporter">transporter</a></li><li><a href="global.html#updateCartItemQuantity">updateCartItemQuantity</a></li><li><a href="global.html#updateMessagesUI">updateMessagesUI</a></li><li><a href="global.html#updateRatingStars">updateRatingStars</a></li><li><a href="global.html#updateSidebarForLoggedInUser">updateSidebarForLoggedInUser</a></li><li><a href="global.html#updateSizeSelection">updateSizeSelection</a></li><li><a href="global.html#updateSummary">updateSummary</a></li><li><a href="global.html#updateWishlistSummary">updateWishlistSummary</a></li><li><a href="global.html#verifyToken">verifyToken</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Tue Dec 02 2025 08:00:47 GMT-0600 (hora estándar central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
