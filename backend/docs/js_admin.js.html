<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: js/admin.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: js/admin.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file js/admin.js
 * @description Script principal del Panel de Administración.
 * Se encarga de la seguridad (verificar sesión y roles), renderizado condicional del menú,
 * carga de estadísticas del dashboard y utilidades como generación de códigos de barras y backups.
 */

/**
 * Inicializa la lógica global del panel de administración al cargar el DOM.
 * 1. Verifica autenticación con el backend.
 * 2. Restringe el acceso a páginas según el 'permission_ring' del usuario.
 * 3. Carga elementos específicos de la página actual (stats, editores, etc.).
 * 4. Configura el botón de cierre de sesión.
 * @listens document#DOMContentLoaded
 */
document.addEventListener("DOMContentLoaded", async () => {
  // ------------------------------------------------------
  // 1. VERIFICACIÓN DE SEGURIDAD Y MENÚ (Se ejecuta en TODAS las páginas)
  // ------------------------------------------------------
  try {
    /**
     * Petición para obtener la sesión actual.
     * @type {Response}
     */
    const meResponse = await fetch("http://localhost:8080/users/me", {
      method: "GET",
      credentials: "include",
    });

    if (!meResponse.ok) throw new Error("No autorizado");

    /** @type {Object} userInfo - Datos del usuario logueado (rol, username, etc.) */
    const userInfo = await meResponse.json();

    // A) Verificación básica de acceso (Admin o Gerente)
    // Ring 0 = Admin, Ring 1 = Gerente. Otros (Ring > 1) no entran.
    if (!userInfo.role || userInfo.role.permission_ring > 1) {
      throw new Error("Acceso denegado");
    }

    // B) Mostrar nombre de usuario en el header
    const usernameDisplay = document.getElementById("admin-username");
    if (usernameDisplay) {
      usernameDisplay.textContent = userInfo.username || "Usuario";
    }

    // C) LÓGICA DE RESTRICCIÓN DE MENÚ
    // Si NO es Admin Supremo (Ring 0), ocultamos opciones críticas.
    if (userInfo.role.permission_ring !== 0) {
      const restrictedPages = [
        "GestionProduc.html", // Gestión Productos
        "GestionUsuarios.html", // Gestión Usuarios
        "GestionCategorias.html", // Gestión Categorías
        "GestionRoles.html", // Gestión Roles
        "ConfiguracionPagos.html",
      ];

      restrictedPages.forEach((page) => {
        // Busca enlaces a páginas restringidas y oculta su contenedor &lt;li>
        const linkElement = document.querySelector(`a[href="${page}"]`);
        if (linkElement) {
          linkElement.parentElement.style.display = "none";
        }
      });

      // Protección adicional: Si intenta entrar por URL directa, lo redirige.
      const path = window.location.pathname;
      const currentPage = path.substring(path.lastIndexOf("/") + 1);

      if (restrictedPages.includes(currentPage)) {
        alert("No tienes permisos para acceder a esta sección.");
        window.location.href = "admin.html"; // Retorno al dashboard seguro
      }
    }

    // ------------------------------------------------------
    // 2. CARGA DE ELEMENTOS ESPECÍFICOS
    // ------------------------------------------------------

    // Cargar estadísticas solo si estamos en el Dashboard principal
    if (document.getElementById("stats-online-revenue")) {
      await loadDashboardStats();
    }
  } catch (error) {
    console.error("Error de autenticación:", error);
    alert("Sesión no válida o permisos insuficientes.");
    window.location.href = "login.html";
  }

  // ------------------------------------------------------
  // 3. LOGOUT Y OTRAS UTILIDADES
  // ------------------------------------------------------
  const logoutBtn = document.getElementById("logout-btn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      try {
        await fetch("http://localhost:8080/auth/logout", {
          method: "POST",
          credentials: "include",
        });
      } catch (err) {
        console.error(err);
      } finally {
        window.location.href = "login.html";
      }
    });
  }

  // Inicializar modal de códigos de barras (funcionalidad global disponible en el menú)
  initializeBarcodesModal();
});

/**
 * Carga las estadísticas financieras y de ventas para el Dashboard.
 * Consume el endpoint de reportes y actualiza el DOM.
 * @async
 */
async function loadDashboardStats() {
  try {
    const response = await fetch(
      "http://localhost:8080/reports/sales-by-channel",
      {
        credentials: "include",
      }
    );

    if (!response.ok) {
      throw new Error("No se pudieron cargar las estadísticas");
    }

    const stats = await response.json(); // { online: {...}, pos: {...} }

    /**
     * Formatea un número como moneda MXN.
     * @param {number} amount
     * @returns {string} Precio formateado (ej. "$1,200.00 MXN")
     */
    const formatCurrency = (amount) =>
      new Intl.NumberFormat("es-MX", {
        style: "currency",
        currency: "MXN",
      }).format(amount || 0);

    // Actualizar el HTML del dashboard
    document.getElementById("stats-online-revenue").textContent =
      formatCurrency(stats.online.revenue);
    document.getElementById("stats-online-sales").textContent =
      stats.online.salesCount;
    document.getElementById("stats-pos-revenue").textContent = formatCurrency(
      stats.pos.revenue
    );
    document.getElementById("stats-pos-sales").textContent =
      stats.pos.salesCount;
  } catch (error) {
    console.error(error.message);
  }
}

/**
 * Inicializa la lógica del modal generador de códigos de barras.
 * Maneja la apertura del modal, carga de productos, generación visual (JsBarcode) e impresión.
 */
function initializeBarcodesModal() {
  const barcodesModal = document.getElementById("barcodes-modal");
  const barcodesMenuBtn = document.getElementById("barcodes-menu-btn");
  const closeBtn = barcodesModal ? barcodesModal.querySelector(".close") : null;

  // Referencias internas del modal
  const productSelect = document.getElementById("productSelect");
  const generateBtn = document.getElementById("generateBtn");
  const printBtn = document.getElementById("printBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const barcodeResult = document.getElementById("barcodeResult");
  const productDisplay = document.getElementById("productDisplay");
  const productDetails = document.getElementById("productDetails");
  const barcodeText = document.getElementById("barcodeText");
  const loadingSection = document.getElementById("loadingSection");
  const barcodeSvg = document.getElementById("barcode");

  let products = [];
  let selectedProduct = null;

  // Listeners de apertura/cierre
  if (barcodesMenuBtn) {
    barcodesMenuBtn.addEventListener("click", (e) => {
      e.preventDefault();
      barcodesModal.style.display = "block";
      loadProducts();
    });
  }

  if (closeBtn) {
    closeBtn.addEventListener("click", () => {
      barcodesModal.style.display = "none";
    });
  }

  window.addEventListener("click", (e) => {
    if (e.target === barcodesModal) {
      barcodesModal.style.display = "none";
    }
  });

  /**
   * Carga la lista de productos desde la API para llenar el selector.
   */
  async function loadProducts() {
    showLoading(true);
    try {
      const response = await fetch("http://localhost:8080/products");

      if (!response.ok) {
        throw new Error(`Error ${response.status}: ${response.statusText}`);
      }

      const variants = await response.json();

      // Mapeamos a una estructura simple para el select
      products = variants.map((variant) => ({
        id: variant._id,
        name: variant.product?.name || "Producto sin nombre",
        base_price: variant.product?.base_price || 0,
        description: variant.product?.description || "",
        category: variant.product?.category || "unisex",
        size: variant.size,
        sku: variant.sku,
        stock: variant.stock,
        image_url: variant.product?.image_url || "sources/img/logo_negro.png",
      }));

      updateProductSelect();
    } catch (error) {
      console.error("Error cargando productos:", error);
      showNotification(
        "Error al cargar los productos: " + error.message,
        "error"
      );
    } finally {
      showLoading(false);
    }
  }

  /**
   * Renderiza las opciones en el elemento &lt;select>.
   */
  function updateProductSelect() {
    productSelect.innerHTML =
      '&lt;option value="">-- Selecciona un producto --&lt;/option>';

    products.forEach((product) => {
      const option = document.createElement("option");
      option.value = product.id;
      option.textContent = `${product.name} - ${product.size} (SKU: ${
        product.sku
      }) - $${product.base_price.toFixed(2)}`;
      productSelect.appendChild(option);
    });
  }

  /**
   * Genera un número consistente basado en una cadena de texto (hash simple).
   * Utilizado para asegurar que el mismo producto siempre genere el mismo código base.
   * @param {string} str - Cadena de entrada (ej. Nombre + SKU).
   * @returns {string} Cadena numérica de 12 dígitos.
   */
  function stringToConsistentNumber(str) {
    str = str.toLowerCase();
    let hash = 0;
    for (let i = 0; i &lt; str.length; i++) {
      const char = str.charCodeAt(i);
      hash = (hash &lt;&lt; 5) - hash + char;
      hash = hash &amp; hash;
    }
    hash = Math.abs(hash);
    let numericString = hash.toString();
    while (numericString.length &lt; 8) {
      numericString = "0" + numericString;
    }
    return numericString.substring(0, 12);
  }

  /**
   * Genera el código de barras visual usando la librería JsBarcode.
   * @param {Object} product - El producto seleccionado.
   */
  function generateBarcode(product) {
    if (!product) {
      showNotification("Por favor, selecciona un producto", "warning");
      return;
    }

    const barcodeValue = stringToConsistentNumber(product.name + product.sku);

    productDisplay.textContent = product.name;
    productDetails.innerHTML = `
            &lt;div class="product-info-detail">
                &lt;strong>SKU:&lt;/strong> ${product.sku} | 
                &lt;strong>Talla:&lt;/strong> ${product.size} | 
                &lt;strong>Precio:&lt;/strong> $${product.base_price.toFixed(2)} | 
                &lt;strong>Stock:&lt;/strong> ${product.stock}
            &lt;/div>
        `;

    barcodeSvg.innerHTML = "";

    // Librería externa para SVG
    JsBarcode("#barcode", barcodeValue, {
      format: "CODE128",
      lineColor: "#000000",
      width: 2,
      height: 100,
      displayValue: true,
      fontSize: 16,
      margin: 10,
      background: "#ffffff",
    });

    barcodeSvg.setAttribute("style", "display: block; background: white;");
    barcodeText.textContent = `Código: ${barcodeValue}`;
    barcodeResult.classList.remove("hidden");
  }

  function showLoading(show) {
    if (loadingSection) {
      if (show) loadingSection.classList.remove("hidden");
      else loadingSection.classList.add("hidden");
    }
  }

  /**
   * Aplica estilos inline al SVG para asegurar que se imprima correctamente (negro puro).
   */
  function applyPrintStyles() {
    const paths = barcodeSvg.querySelectorAll("path");
    const rects = barcodeSvg.querySelectorAll("rect");
    const texts = barcodeSvg.querySelectorAll("text");

    barcodeSvg.style.background = "white";
    barcodeSvg.style.border = "1px solid #ccc";
    barcodeSvg.style.padding = "10px";

    paths.forEach((path) => {
      if (path.getAttribute("fill") !== "#ffffff") {
        path.style.fill = "#000000";
        path.style.stroke = "#000000";
      }
    });

    rects.forEach((rect) => {
      if (rect.getAttribute("fill") === "#ffffff") {
        rect.style.fill = "#ffffff";
        rect.style.stroke = "#ffffff";
      }
    });

    texts.forEach((text) => {
      text.style.fill = "#000000";
      text.style.stroke = "none";
    });
  }

  function restoreNormalStyles() {
    barcodeSvg.style.background = "";
    barcodeSvg.style.border = "";
    barcodeSvg.style.padding = "";
  }

  // Event listeners internos del modal
  if (generateBtn) {
    generateBtn.addEventListener("click", function () {
      if (productSelect.value) {
        const product = products.find((p) => p.id === productSelect.value);
        if (product) {
          generateBarcode(product);
        }
      } else {
        showNotification(
          "Por favor, selecciona un producto de la lista",
          "warning"
        );
      }
    });
  }

  if (productSelect) {
    productSelect.addEventListener("change", function () {
      if (this.value) {
        const product = products.find((p) => p.id === this.value);
        if (product) {
          selectedProduct = product;
          generateBarcode(product);
        }
      } else {
        selectedProduct = null;
        barcodeResult.classList.add("hidden");
      }
    });
  }

  if (printBtn) {
    printBtn.addEventListener("click", function () {
      if (!selectedProduct) {
        showNotification(
          "No hay ningún producto seleccionado para imprimir",
          "warning"
        );
        return;
      }
      applyPrintStyles();
      setTimeout(() => {
        window.print(); // Abre el diálogo de impresión del navegador
        setTimeout(restoreNormalStyles, 500);
      }, 100);
    });
  }

  if (refreshBtn) {
    refreshBtn.addEventListener("click", function () {
      loadProducts();
    });
  }
}

// Lógica de respaldo de base de datos
const backupBtn = document.getElementById("backup-btn");
if (backupBtn) {
  backupBtn.addEventListener("click", async (e) => {
    e.preventDefault();

    if (
      !confirm(
        "¿Deseas generar y descargar una copia de seguridad completa del sistema?"
      )
    ) {
      return;
    }

    const originalText = backupBtn.innerHTML;
    backupBtn.innerHTML = '&lt;i class="fas fa-spinner fa-spin">&lt;/i> Generando...';
    document.body.style.cursor = "wait";

    try {
      /**
       * Petición al endpoint de backup que devuelve un archivo ZIP (blob).
       */
      const response = await fetch("http://localhost:8080/backup/download", {
        method: "GET",
        credentials: "include",
      });

      if (response.ok) {
        const blob = await response.blob();
        // Crear URL temporal para descarga forzada
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Respaldo_RopaDB_${new Date()
          .toISOString()
          .slice(0, 10)}.zip`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      } else {
        const err = await response.json();
        alert(
          "Error: " + (err.message || "No tienes permisos o falló el servidor")
        );
      }
    } catch (error) {
      console.error(error);
      alert("Error de conexión al intentar descargar el respaldo.");
    } finally {
      backupBtn.innerHTML = originalText;
      document.body.style.cursor = "default";
    }
  });
}

/**
 * Muestra una notificación flotante (Toast) en la interfaz.
 * @param {string} message - Texto a mostrar.
 * @param {'info'|'success'|'error'|'warning'} [type='info'] - Tipo de notificación.
 */
function showNotification(message, type = "info") {
  const existing = document.querySelector(".notification");
  if (existing) existing.remove();

  const notification = document.createElement("div");
  notification.className = `notification notification-${type}`;

  let icon = "info-circle";
  if (type === "success") icon = "check-circle";
  if (type === "error") icon = "exclamation-circle";
  if (type === "warning") icon = "exclamation-triangle";

  notification.innerHTML = `
        &lt;i class="fas fa-${icon}">&lt;/i>
        &lt;span>${message}&lt;/span>
        &lt;button class="notification-close" onclick="this.parentElement.remove()">&amp;times;&lt;/button>
    `;

  document.body.appendChild(notification);

  // Auto-eliminar a los 4 segundos
  setTimeout(() => {
    if (notification.parentElement) {
      notification.style.opacity = "0";
      setTimeout(() => notification.remove(), 500);
    }
  }, 4000);
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CategoryManager.html">CategoryManager</a></li><li><a href="ProductManager.html">ProductManager</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:submit">submit</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addBtn">addBtn</a></li><li><a href="global.html#addWishlistListeners">addWishlistListeners</a></li><li><a href="global.html#allCategoryProducts">allCategoryProducts</a></li><li><a href="global.html#allowedOrigins">allowedOrigins</a></li><li><a href="global.html#applyFilters">applyFilters</a></li><li><a href="global.html#approveOrder">approveOrder</a></li><li><a href="global.html#availableRoles">availableRoles</a></li><li><a href="global.html#cancelBtn">cancelBtn</a></li><li><a href="global.html#cargarTerminosUsuario">cargarTerminosUsuario</a></li><li><a href="global.html#checkIfEmpty">checkIfEmpty</a></li><li><a href="global.html#checkLoginStatus">checkLoginStatus</a></li><li><a href="global.html#closeCouponModal">closeCouponModal</a></li><li><a href="global.html#closeEditModal">closeEditModal</a></li><li><a href="global.html#closeProviderModal">closeProviderModal</a></li><li><a href="global.html#closeUserModal">closeUserModal</a></li><li><a href="global.html#couponForm">couponForm</a></li><li><a href="global.html#createEditModal">createEditModal</a></li><li><a href="global.html#createOrderCardHTML">createOrderCardHTML</a></li><li><a href="global.html#createProductHTML">createProductHTML</a></li><li><a href="global.html#createReviewHTML">createReviewHTML</a></li><li><a href="global.html#createStarsHTML">createStarsHTML</a></li><li><a href="global.html#currentEditingUserId">currentEditingUserId</a></li><li><a href="global.html#currentUserRing">currentUserRing</a></li><li><a href="global.html#db">db</a></li><li><a href="global.html#deleteCoupon">deleteCoupon</a></li><li><a href="global.html#deleteProvider">deleteProvider</a></li><li><a href="global.html#deleteReview">deleteReview</a></li><li><a href="global.html#displayProducts">displayProducts</a></li><li><a href="global.html#editReview">editReview</a></li><li><a href="global.html#editarRol">editarRol</a></li><li><a href="global.html#editingCouponId">editingCouponId</a></li><li><a href="global.html#editingProviderId">editingProviderId</a></li><li><a href="global.html#editingReviewId">editingReviewId</a></li><li><a href="global.html#eliminarRol">eliminarRol</a></li><li><a href="global.html#form">form</a></li><li><a href="global.html#formatDate">formatDate</a></li><li><a href="global.html#generateCouponCode">generateCouponCode</a></li><li><a href="global.html#getStatusLabel">getStatusLabel</a></li><li><a href="global.html#getUrgencyLabel">getUrgencyLabel</a></li><li><a href="global.html#goBackToProducts">goBackToProducts</a></li><li><a href="global.html#handleFormSubmit">handleFormSubmit</a></li><li><a href="global.html#hasPermission">hasPermission</a></li><li><a href="global.html#initializeBarcodesModal">initializeBarcodesModal</a></li><li><a href="global.html#initializeCarousels">initializeCarousels</a></li><li><a href="global.html#initializeCatProductButtons">initializeCatProductButtons</a></li><li><a href="global.html#initializeCatWishlistButtons">initializeCatWishlistButtons</a></li><li><a href="global.html#initializeMessagesSystem">initializeMessagesSystem</a></li><li><a href="global.html#initializeProductButtons">initializeProductButtons</a></li><li><a href="global.html#initializeWishlistButtons">initializeWishlistButtons</a></li><li><a href="global.html#isEditing">isEditing</a></li><li><a href="global.html#loadBestSellersReport">loadBestSellersReport</a></li><li><a href="global.html#loadCartItems">loadCartItems</a></li><li><a href="global.html#loadCategoryProducts">loadCategoryProducts</a></li><li><a href="global.html#loadCoupons">loadCoupons</a></li><li><a href="global.html#loadDashboardStats">loadDashboardStats</a></li><li><a href="global.html#loadDynamicCategories">loadDynamicCategories</a></li><li><a href="global.html#loadEmployeeSalesReport">loadEmployeeSalesReport</a></li><li><a href="global.html#loadMessagesFromBackend">loadMessagesFromBackend</a></li><li><a href="global.html#loadProducts">loadProducts</a></li><li><a href="global.html#loadProviders">loadProviders</a></li><li><a href="global.html#loadRoles">loadRoles</a></li><li><a href="global.html#loadUserData">loadUserData</a></li><li><a href="global.html#loadUserDataAndProducts">loadUserDataAndProducts</a></li><li><a href="global.html#loadUserOrders">loadUserOrders</a></li><li><a href="global.html#loadUserReviews">loadUserReviews</a></li><li><a href="global.html#loadUsers">loadUsers</a></li><li><a href="global.html#loadWebOrders">loadWebOrders</a></li><li><a href="global.html#loadWishlistItems">loadWishlistItems</a></li><li><a href="global.html#markAllAsRead">markAllAsRead</a></li><li><a href="global.html#markMessageAsRead">markMessageAsRead</a></li><li><a href="global.html#modal">modal</a></li><li><a href="global.html#modalTitle">modalTitle</a></li><li><a href="global.html#moveItemToCart">moveItemToCart</a></li><li><a href="global.html#openCreateModal">openCreateModal</a></li><li><a href="global.html#openEditModal">openEditModal</a></li><li><a href="global.html#productGrid">productGrid</a></li><li><a href="global.html#productsToInsert">productsToInsert</a></li><li><a href="global.html#providerForm">providerForm</a></li><li><a href="global.html#recalculateSummary">recalculateSummary</a></li><li><a href="global.html#recalculateTotal">recalculateTotal</a></li><li><a href="global.html#rejectOrder">rejectOrder</a></li><li><a href="global.html#removeFromWishlist">removeFromWishlist</a></li><li><a href="global.html#removeItemFromCart">removeItemFromCart</a></li><li><a href="global.html#renderProducts">renderProducts</a></li><li><a href="global.html#resetForm">resetForm</a></li><li><a href="global.html#selectProduct">selectProduct</a></li><li><a href="global.html#selectedProduct">selectedProduct</a></li><li><a href="global.html#selectedProvider">selectedProvider</a></li><li><a href="global.html#selectedRating">selectedRating</a></li><li><a href="global.html#selectedSize">selectedSize</a></li><li><a href="global.html#sendPasswordResetEmail">sendPasswordResetEmail</a></li><li><a href="global.html#setupCartEventListeners">setupCartEventListeners</a></li><li><a href="global.html#setupEditModalListeners">setupEditModalListeners</a></li><li><a href="global.html#setupEventListeners">setupEventListeners</a></li><li><a href="global.html#setupFilterListeners">setupFilterListeners</a></li><li><a href="global.html#setupModal">setupModal</a></li><li><a href="global.html#setupScrollEffects">setupScrollEffects</a></li><li><a href="global.html#shippingData">shippingData</a></li><li><a href="global.html#showMessageDetail">showMessageDetail</a></li><li><a href="global.html#showMessagesError">showMessagesError</a></li><li><a href="global.html#showNotification">showNotification</a></li><li><a href="global.html#startMessagesRealTimeUpdates">startMessagesRealTimeUpdates</a></li><li><a href="global.html#submitReview">submitReview</a></li><li><a href="global.html#tableBody">tableBody</a></li><li><a href="global.html#toggleWishlistItem">toggleWishlistItem</a></li><li><a href="global.html#toggleWishlistItemCat">toggleWishlistItemCat</a></li><li><a href="global.html#transporter">transporter</a></li><li><a href="global.html#updateCartItemQuantity">updateCartItemQuantity</a></li><li><a href="global.html#updateMessagesUI">updateMessagesUI</a></li><li><a href="global.html#updateRatingStars">updateRatingStars</a></li><li><a href="global.html#updateSidebarForLoggedInUser">updateSidebarForLoggedInUser</a></li><li><a href="global.html#updateSizeSelection">updateSizeSelection</a></li><li><a href="global.html#updateSummary">updateSummary</a></li><li><a href="global.html#updateWishlistSummary">updateWishlistSummary</a></li><li><a href="global.html#verifyToken">verifyToken</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Tue Dec 02 2025 08:00:47 GMT-0600 (hora estándar central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
